---
name: dev-tdd-workflow
description: 通用 TDD 工作流（合并 command + skill）。用于新功能、修复 bug、重构时强制先写测试，覆盖率 80%+，包含单元/集成/E2E 测试。
---

# 测试驱动开发工作流

## 概述

用于在开发过程中强制执行先写测试、再实现、再重构的流程，并保证覆盖率达标。

## 何时启用

- 实现新功能或新增模块/组件
- 修复 bug 或问题（先写可复现的失败测试）
- 重构现有代码或关键业务逻辑
- 新增 API 端点或关键流程

## 快速流程（原 /tdd command 核心步骤）

1. **建立接口/类型骨架**（先定义输入/输出）
2. **先写失败测试**（RED）
3. **最小实现**（GREEN）
4. **重构**（REFACTOR）
5. **检查覆盖率**（至少 80%）

## TDD 循环

```
RED → GREEN → REFACTOR → REPEAT

RED:      编写失败的测试
GREEN:    实现最小代码让测试通过
REFACTOR: 改进代码并保持测试通过
REPEAT:   下一个场景/功能
```

## 详细步骤

### 步骤 1：编写用户旅程
```
作为 [角色]，我想要 [动作]，以便 [收益]
```

### 步骤 2：生成测试用例
- 为每个旅程覆盖：正常路径、边界值、错误路径
- 先写会失败的测试（验证失败原因正确）

### 步骤 3：运行测试并确认失败
- 失败原因必须与“尚未实现/逻辑缺失”一致

### 步骤 4：最小实现（GREEN）
- 只写足够通过测试的实现

### 步骤 5：运行测试并确认通过
- 所有测试必须变绿

### 步骤 6：重构（REFACTOR）
- 消除重复
- 改进命名与可读性
- 在测试保持绿色的前提下优化结构/性能

### 步骤 7：验证覆盖率
- 最低 80%
- 覆盖不足时补测试

## 测试类型

### 单元测试
- 单个函数/工具
- 组件逻辑
- 纯函数

### 集成测试
- API 端点
- 数据库操作
- 服务交互
- 外部 API 调用

### E2E 测试
- 关键用户流程
- 完整工作流
- UI 交互

## 覆盖率要求

- **全量最低 80%**
- **以下必须 100%**：
  - 金融计算
  - 认证逻辑
  - 安全关键代码
  - 核心业务逻辑

## 最佳实践（精简）

1. **测试先于代码**，绝不跳过 RED
2. **一条测试一个行为**，断言具体且有意义
3. **边界/错误路径必须覆盖**
4. **保持测试快速**，优先单元测试
5. **重构前后都要测试全绿**

## 与 Agent/流程配合

- 需要执行型引导时可配合 `tdd-guide-ts` 或 `tdd-guide-py` Agent。