# 深度研究方法论

本文档详细描述深度研究系统采用的研究方法论。

## 研究循环

### 核心循环结构

```
┌─────────────────────────────────────────────┐
│              研究循环                        │
│                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐ │
│  │ 搜索     │───▶│ 提取洞察 │───▶│ 生成追问 │ │
│  │ Search  │    │ Extract │    │ Followup│ │
│  └────┬────┘    └────┬────┘    └────┬────┘ │
│       │              │              │       │
│       ▼              ▼              ▼       │
│  ┌─────────────────────────────────────┐   │
│  │           评估 & 终止检查            │   │
│  │    深度 < max_depth?                │   │
│  │    时间 < time_limit?               │   │
│  │    洞察充分?                        │   │
│  └─────────────────────────────────────┘   │
│           │ 是               │ 否            │
│           ▼                 ▼              │
│       继续循环            生成报告          │
└─────────────────────────────────────────────┘
```

### 第一阶段：查询优化

**目标**：将用户的原始查询转化为更有效的搜索查询。

**优化策略**：

1. **关键词扩展**
   ```
   原始: "机器学习优化"
   优化: "机器学习 模型优化 超参数调优 2024 最新进展"
   ```

2. **上下文注入**
   ```
   原始: "RAG 技术"
   优化: "RAG 检索增强生成 大语言模型 向量数据库"
   ```

3. **时间过滤**
   ```
   原始: "AI 芯片"
   优化: "AI 芯片 2024 最新产品 性能对比"
   ```

### 第二阶段：搜索执行

**搜索参数**：
- `query`: 优化后的搜索查询
- `filter_year`: 可选的年份过滤
- `num_results`: 返回结果数量（默认 10）

**结果处理**：
1. 去重（基于 URL）
2. 质量评分（基于域名、内容长度）
3. 内容抓取（如果启用了 fetch_content）

### 第三阶段：洞察提取

**提取过程**：

```
搜索结果
    │
    ▼
┌─────────────────┐
│   内容筛选       │ → 排除已访问、空内容
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   LLM 分析      │ → 提取关键洞察 + 相关性评分
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   洞察结构化     │ → 转换为 ResearchInsight 对象
└─────────────────┘
```

**洞察评分标准**：
- **0.8-1.0**: 高度相关，直接回答查询
- **0.5-0.8**: 中等相关，提供有用背景
- **0.0-0.5**: 低相关，边缘信息

**提取限制**：
- 每个来源最多 3 条洞察
- 单次提取限制内容长度（防止 token 溢出）

### 第四阶段：追问生成

**生成逻辑**：

```
已有洞察
    │
    ▼
┌─────────────────┐
│   识别缺口       │ → 哪些方面还没有覆盖到？
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   LLM 生成       │ → 基于缺口生成追问
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   追问筛选       │ → 最多 3 个追问
└─────────────────┘
```

**追问生成提示模板**：
```
原始查询: {original_query}
当前查询: {current_query}
已发现的洞察:
{insights}

请生成最多 3 个后续查询，帮助填补当前知识的空白。
每个查询应该简洁且专注于研究主题的特定方面。
```

## 深度控制

### 分支因子控制

```
Level 0: 原始查询 (1个)
         │
         ├─→ Level 1: 追问 1, 2, 3 (最多3个)
         │        │
         │        ├─→ Level 2: 追问 1-1, 1-2 (最多2个)
         │        └─→ Level 2: 追问 2-1, 2-2
         │
         └─→ ...
```

**控制参数**：
- `max_depth`: 最大研究深度（默认 2）
- `max_follow_ups`: 每层的追问数量（默认 3）
- `branching_factor`: 实际执行的分支数（默认 2）

### 时间控制

```
start_time = time.time()
deadline = start_time + time_limit_seconds

每次循环前检查:
if time.time() >= deadline:
    终止研究，生成报告
```

## 结果整合

### 洞察聚合

```python
# 按相关性分组
grouped_insights = {
    "Key Findings": [i for i in insights if i.relevance_score >= 0.8],
    "Additional Information": [i for i in insights if 0.5 <= i.relevance_score < 0.8],
    "Supplementary Information": [i for i in insights if i.relevance_score < 0.5]
}

# 按相关性排序
sorted_insights = sorted(insights, key=lambda x: x.relevance_score, reverse=True)
```

### 报告生成

```
# Research: {原始查询}
**Sources**: {访问URL数量} | **Depth**: {达到的深度}

## Key Findings
[高相关性洞察列表，带来源引用]

## Additional Information
[中等相关性洞察列表，带来源引用]

## Supplementary Information
[低相关性洞察列表，带来源引用]
```

## 质量保证

### 信息验证

1. **来源验证**
   - 检查 URL 有效性
   - 评估域名权威性
   - 检查内容时效性

2. **内容验证**
   - 交叉验证关键信息
   - 识别潜在偏见
   - 标注不确定性

### 去重策略

```python
def deduplicate_insights(insights):
    # 基于内容相似度去重
    unique_insights = []
    for insight in insights:
        if not is_similar_to_existing(insight, unique_insights):
            unique_insights.append(insight)
    return unique_insights
```

### 置信度评分

```python
confidence_score = (
    source_reliability * 0.3 +
    content_freshness * 0.2 +
    cross_validation * 0.3 +
    relevance_score * 0.2
)
```

## 特殊场景处理

### 场景 1：信息不足

**症状**：
- 搜索结果少于 5 个
- 洞察数量少于阈值
- 内容质量评分低

**处理策略**：
1. 扩大搜索范围（更宽泛的查询）
2. 延长搜索时间
3. 降低质量阈值
4. 标注信息不足警告

### 场景 2：信息过载

**症状**：
- 搜索结果过多（>50）
- 高质量洞察过多
- 内容过于分散

**处理策略**：
1. 提高相关性阈值
2. 聚焦核心主题
3. 合并相似洞察
4. 限制报告长度

### 场景 3：信息冲突

**症状**：
- 不同来源给出矛盾的信息
- 数据不一致
- 观点分歧

**处理策略**：
1. 识别冲突点
2. 评估各来源的可信度
3. 在报告中说明分歧
4. 提供多角度视角

## 性能指标

### 效率指标

- **平均响应时间**: < 60 秒（默认配置）
- **每层平均时间**: < 30 秒
- **单次搜索时间**: < 5 秒

### 质量指标

- **高相关性洞察比例**: > 50%
- **来源多样性**: 覆盖至少 5 个不同域名
- **内容新鲜度**: 优先展示最近 1 年的内容

### 资源使用

- **Token 使用**: 每次研究 < 50k tokens
- **API 调用**: < 20 次
- **网络请求**: < 50 次
